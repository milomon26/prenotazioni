<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Homepage Prenotazioni</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="data:;base64,=">
</head>
<body>
  <!-- NAVBAR -->
  <nav>
    <div class="placeholder"></div>
    <div class="dropdown">
      <button id="menuBtn" class="dropdown-button">Menù</button>
      <div id="menuContent" class="dropdown-content">
        <a href="#" id="loginLink">Login</a>
      </div>
    </div>
  </nav>

  <!-- CALENDARIO -->
  <div class="calendar-container">
    <div class="calendar-nav">
      <button class="primary-button" id="prevMonth">&lt;</button>
      <h2 id="monthYear"></h2>
      <button class="primary-button" id="nextMonth">&gt;</button>
    </div>
    <table class="calendar">
      <thead>
        <tr>
          <th>Lunedì</th><th>Martedì</th><th>Mercoledì</th><th>Giovedì</th>
          <th>Venerdì</th><th>Sabato</th><th>Domenica</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>

  <!-- MODAL LOGIN -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Accedi come admin</h2>
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Username">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Password">
      <button class="primary-button" id="submitLogin">Entra</button>
    </div>
  </div>

  <!-- MODAL PRENOTAZIONE -->
  <div id="bookingModal" class="modal">
    <div class="modal-content">
      <h2>Prenota slot</h2>
      <p id="bookingSlotInfo"></p>
      <label for="customerName">Nome</label>
      <input type="text" id="customerName" placeholder="Il tuo nome">
      <label for="customerPhone">Telefono</label>
      <input type="text" id="customerPhone" placeholder="Il tuo telefono">
      <div class="actions">
        <button class="secondary-button" id="cancelBooking">Annulla</button>
        <button class="primary-button" id="confirmBooking">Conferma</button>
      </div>
    </div>
  </div>

  <!-- MODAL OVERFLOW -->
  <div id="overflowModal" class="modal">
    <div class="modal-content">
      <h2>Altri slot disponibili</h2>
      <div id="overflowContent"></div>
      <div class="actions">
        <button class="secondary-button" id="closeOverflow">Chiudi</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs,
      updateDoc, doc, query, where
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTc-IEX2IlfQwL2n-r-lbWepxys0dEco",
      authDomain: "prenotazioni-app-87467.firebaseapp.com",
      projectId: "prenotazioni-app-87467",
      storageBucket: "prenotazioni-app-87467.appspot.com",
      messagingSenderId: "322391103742",
      appId: "1:322391103742:web:6f74e033b57281bdaaedaf"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let slotsByDate = {}, currentYear, currentMonth, bookingSlot = null;

    // Calcolo di Pasqua (Meeus/Jones)
    function getEasterDate(year) {
      const f = Math.floor, G = year % 19, C = f(year/100);
      const H = (C - f(C/4) - f((8*C+13)/25) + 19*G + 15) % 30;
      const I = H - f(H/28)*(1 - f(H/28)*f(29/(H+1))*f((21-G)/11));
      const J = (year + f(year/4) + I + 2 - C + f(C/4)) % 7;
      const L = I - J, m = 3 + f((L+40)/44);
      const d = L + 28 - 31*f(m/4);
      return new Date(year, m-1, d);
    }

    // Carica gli slot visibili da Firestore
    async function loadSlots() {
      const snap = await getDocs(collection(db, 'slots'));
      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.visible) {
          slotsByDate[d.date] = slotsByDate[d.date] || [];
          slotsByDate[d.date].push({
            id: docSnap.id,
            start: d.start,
            end: d.end,
            occupied: d.occupied || false
          });
        }
      });
    }

    // Render del calendario
    function renderCalendar(year, month) {
      const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                          "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
      document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

      const tbody = document.getElementById('calendarBody');
      tbody.innerHTML = '';
      const today = new Date(); today.setHours(0,0,0,0);

      // Festivi fissi + Pasqua/Pasquetta
      const fixed = ['01-01','04-25','05-01','06-02','08-15','12-25']
        .map(d => `${year}-${d}`);
      const eas = getEasterDate(year);
      const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      fixed.push(fmt(eas), fmt(new Date(eas.getTime()+86400000)));

      const firstDay = new Date(year, month, 1).getDay();
      const shift    = (firstDay + 6) % 7;
      const daysInMonth  = new Date(year, month+1, 0).getDate();

      let day = 1;
      for (let w = 0; w < 6; w++) {
        const tr = document.createElement('tr');
        for (let d = 0; d < 7; d++) {
          const td = document.createElement('td');
          if ((w === 0 && d < shift) || day > daysInMonth) {
            // vuota
          } else {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const cellDate = new Date(year, month, day);

            const num = document.createElement('span');
            num.className = 'day-number';
            num.textContent = day;
            td.append(num);

            if (d === 6 || fixed.includes(dateStr)) td.classList.add('holiday');
            if (cellDate < today) td.classList.add('past-day');

            // filtriamo solo i liberi
            const slots = (slotsByDate[dateStr]||[]).filter(s => !s.occupied);

            slots.slice(0,4).forEach(s => {
              const div = document.createElement('div');
              div.className = 'slot-item clickable';
              div.dataset.date   = dateStr;
              div.dataset.slotId = s.id;

              const span = document.createElement('span');
              span.className = 'slot-text visible';
              span.textContent = `${s.start}–${s.end}`;
              div.append(span);

              td.append(div);
            });

            if (slots.length > 4) {
              const btn = document.createElement('button');
              btn.className = 'show-more-button';
              btn.textContent = `Vedi altri ${slots.length-4}`;
              btn.dataset.date = dateStr;
              td.append(btn);
            }

            day++;
          }
          tr.append(td);
        }
        tbody.append(tr);
        if (day > daysInMonth) break;
      }
    }

    // Apri il popup di prenotazione
    function openBookingModal(date, slot) {
      bookingSlot = slot;
      document.getElementById('customerName').value = '';
      document.getElementById('customerPhone').value = '';
      document.getElementById('bookingSlotInfo').textContent = `${date} ${slot.start}–${slot.end}`;
      document.getElementById('bookingModal').style.display = 'flex';
    }

    // Apri il popup “Vedi altri…”
    function openOverflowModal(date) {
      const cont = document.getElementById('overflowContent');
      cont.innerHTML = '';
      (slotsByDate[date]||[]).filter(s => !s.occupied).slice(4).forEach(s => {
        const div = document.createElement('div');
        div.className = 'slot-item clickable';
        div.dataset.date   = date;
        div.dataset.slotId = s.id;
        const span = document.createElement('span');
        span.className = 'slot-text visible';
        span.textContent = `${s.start}–${s.end}`;
        div.append(span);
        cont.append(div);
      });
      document.getElementById('overflowModal').style.display = 'flex';
    }

    // Tutti i binding dentro DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
      // Dropdown
      const menuBtn     = document.getElementById('menuBtn');
      const menuContent = document.getElementById('menuContent');
      menuBtn.onclick = e => { e.stopPropagation(); menuContent.style.display = menuContent.style.display==='block'?'none':'block'; };
      document.addEventListener('click', e => { if (!menuContent.contains(e.target)) menuContent.style.display='none'; });

      // Login
      const loginModal = document.getElementById('loginModal');
      document.getElementById('loginLink').onclick = e => { e.preventDefault(); loginModal.style.display='flex'; };
      document.getElementById('submitLogin').onclick = async () => {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if (!u||!p) return alert('Compila tutti i campi');
        const snap = await getDocs(query(collection(db,'admins'),where('username','==',u),where('password','==',p)));
        if (!snap.empty) location.href='gestione.html'; else alert('Credenziali non valide');
      };
      window.addEventListener('click', e => { if (e.target===loginModal) loginModal.style.display='none'; });

      // Booking modal
      const bookingModal  = document.getElementById('bookingModal');
      document.getElementById('cancelBooking').onclick = () => bookingModal.style.display='none';
      document.getElementById('confirmBooking').onclick = async () => {
        const name  = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        if (!bookingSlot||!name||!phone) return alert('Compila tutti i campi');
        await updateDoc(doc(db,'slots',bookingSlot.id),{occupied:true,customerName:name,customerPhone:phone});
        bookingSlot.occupied = true;
        bookingModal.style.display='none';
        renderCalendar(currentYear, currentMonth);
      };
      window.addEventListener('click', e => { if (e.target===bookingModal) bookingModal.style.display='none'; });

      // Overflow modal close
      document.getElementById('closeOverflow').onclick = () =>
        document.getElementById('overflowModal').style.display='none';

      // Delegation: slot e “vedi altri”
      document.getElementById('calendarBody').addEventListener('click', e => {
        const slotDiv = e.target.closest('.slot-item.clickable');
        if (slotDiv) {
          const dateStr = slotDiv.dataset.date, slotId = slotDiv.dataset.slotId;
          const slot = (slotsByDate[dateStr]||[]).find(s => s.id===slotId);
          if (slot) openBookingModal(dateStr, slot);
        }
        const btn = e.target.closest('.show-more-button');
        if (btn) openOverflowModal(btn.dataset.date);
      });

      // Navigazione mesi
      document.getElementById('prevMonth').onclick = () => {
        currentMonth--; if (currentMonth<0) { currentMonth=11;currentYear--; }
        renderCalendar(currentYear, currentMonth);
      };
      document.getElementById('nextMonth').onclick = () => {
        currentMonth++; if (currentMonth>11) { currentMonth=0;currentYear++; }
        renderCalendar(currentYear, currentMonth);
      };

      // Inizializzo
      await loadSlots();
      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth();
      renderCalendar(currentYear, currentMonth);
    });
  </script>
</body>
</html>
