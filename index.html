<!-- index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Cute</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Menu a tendina click-to-open -->
  <nav class="dropdown-menu">
    <button class="menu-button" id="menu-button">Menu</button>
    <ul class="menu-list">
      <li class="menu-item" id="login-button">Login</li>
    </ul>
  </nav>

  <!-- Popup di login -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <span id="close-modal" class="close">×</span>
      <h2>Login Admin</h2>
      <input type="text" id="login-username" placeholder="Username" />
      <input type="password" id="login-password" placeholder="Password" />
      <button id="login-submit" class="menu-button">Accedi</button>
      <p id="login-error" class="error-message"></p>
    </div>
  </div>

  <!-- Calendario -->
  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev-month">←</button>
      <h2 id="month-year"></h2>
      <button id="next-month">→</button>
    </div>
    <table class="calendar">
      <thead>
        <tr id="day-names"></tr>
      </thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </div>

  <script>
    // Toggle menu
    document.addEventListener('click', () => {
      document.querySelectorAll('.menu-list').forEach(ul => ul.style.display = 'none');
    });
    document.getElementById('menu-button').addEventListener('click', e => {
      e.stopPropagation();
      const ul = document.querySelector('.dropdown-menu .menu-list');
      ul.style.display = ul.style.display === 'block' ? 'none' : 'block';
    });

    // Modal login
    const modal = document.getElementById('login-modal');
    const openBtn = document.getElementById('login-button');
    const closeBtn = document.getElementById('close-modal');
    openBtn.addEventListener('click', e => { e.stopPropagation(); showModal(); });
    closeBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });
    function showModal() { document.getElementById('login-error').textContent = ''; modal.classList.add('active'); }
    function hideModal() { modal.classList.remove('active'); }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBTc-IEX2IlfQXwL2n-r-lbWepxys0dEco",
      authDomain: "prenotazioni-app-87467.firebaseapp.com",
      projectId: "prenotazioni-app-87467",
      storageBucket: "prenotazioni-app-87467.firebasestorage.app",
      messagingSenderId: "322391103742",
      appId: "1:322391103742:web:6f74e033b57281bdaaedaf"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Submit login
    document.getElementById('login-submit').addEventListener('click', async () => {
      const username = document.getElementById('login-username').value;
      const pass = document.getElementById('login-password').value;
      try {
        const uc = await auth.signInWithEmailAndPassword(username, pass);
        const adminDoc = await db.collection('admins').doc(uc.user.uid).get();
        if (adminDoc.exists) {
          hideModal();
          window.location.href = 'gestione.html';
        } else {
          await auth.signOut();
          document.getElementById('login-error').textContent = 'Utente non autorizzato';
        }
      } catch (e) {
        document.getElementById('login-error').textContent = e.message;
      }
    });

    // Calcola Pasqua (Meeus)
    function calculateEaster(year) {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const L = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * L) / 451);
      const month = Math.floor((h + L - 7 * m + 114) / 31);
      const day = ((h + L - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    // Festività italiane
    function getItalianHolidays(year) {
      const easter = calculateEaster(year);
      const easterMon = new Date(easter);
      easterMon.setDate(easter.getDate() + 1);
      const fixed = [
        new Date(year, 0, 1), new Date(year, 0, 6),
        new Date(year, 3, 25), new Date(year, 4, 1),
        new Date(year, 5, 2), new Date(year, 7, 15),
        new Date(year, 10, 1), new Date(year, 11, 8),
        new Date(year, 11, 25), new Date(year, 11, 26)
      ];
      return [easter, easterMon, ...fixed].map(d => {
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${d.getFullYear()}-${mm}-${dd}`;
      });
    }

    // Rendering calendar
    function renderCalendar() {
      const today = window.calendarDate;
      const year = today.getFullYear();
      const month = today.getMonth();
      const holidays = getItalianHolidays(year);

      let mn = today.toLocaleString('it-IT', { month: 'long' });
      mn = mn.charAt(0).toUpperCase() + mn.slice(1);
      document.getElementById('month-year').textContent = `${mn} ${year}`;

      const names = ['Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato','Domenica'];
      const head = document.getElementById('day-names'); head.innerHTML = '';
      names.forEach(n => { const th = document.createElement('th'); th.textContent = n; head.appendChild(th); });

      const first = new Date(year, month, 1);
      const start = (first.getDay() + 6) % 7;
      const dim = new Date(year, month + 1, 0).getDate();
      const rows = Math.ceil((start + dim) / 7);
      const body = document.getElementById('calendar-body'); body.innerHTML = '';
      let d = 1;
      for (let i = 0; i < rows; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          const idx = i * 7 + j;
          if (idx < start || d > dim) cell.textContent = '';
          else {
            const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            cell.textContent = d;
            if (j === 6) cell.classList.add('sunday');
            if (holidays.includes(ds)) cell.classList.add('holiday');
            d++;
          }
          row.appendChild(cell);
        }
        body.appendChild(row);
      }
    }

    // State and controls
    window.calendarDate = new Date();
    document.getElementById('prev-month').addEventListener('click', () => {
      window.calendarDate.setMonth(window.calendarDate.getMonth() - 1);
      renderCalendar();
    });
    document.getElementById('next-month').addEventListener('click', () => {
      window.calendarDate.setMonth(window.calendarDate.getMonth() + 1);
      renderCalendar();
    });
    renderCalendar();
  </script>
