<!-- index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Cute</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Menu -->
  <nav class="dropdown-menu">
    <button class="menu-button" id="menu-button">Menu</button>
    <ul class="menu-list">
      <li class="menu-item" id="login-button">Login</li>
    </ul>
  </nav>

  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <span id="close-modal" class="close">×</span>
      <h2>Login Admin</h2>
      <input type="text" id="login-username" placeholder="Username">
      <input type="password" id="login-password" placeholder="Password">
      <button id="login-submit" class="menu-button">Accedi</button>
      <p id="login-error" class="error-message"></p>
    </div>
  </div>

  <!-- Calendario -->
  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev-month">←</button>
      <h2 id="month-year"></h2>
      <button id="next-month">→</button>
    </div>
    <table class="calendar">
      <thead><tr id="day-names"></tr></thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </div>

  <script>
    // Toggle menu visibility
    document.addEventListener('click', () => {
      document.querySelectorAll('.menu-list').forEach(ul => ul.style.display = 'none');
    });
    document.getElementById('menu-button').addEventListener('click', e => {
      e.stopPropagation();
      const ul = document.querySelector('.dropdown-menu .menu-list');
      ul.style.display = ul.style.display === 'block' ? 'none' : 'block';
    });

    // Modal logic
    const modal = document.getElementById('login-modal');
    document.getElementById('login-button').addEventListener('click', e => {
      e.stopPropagation(); modal.classList.add('active');
    });
    document.getElementById('close-modal').addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBTc-IEX2IlfQXwL2n-r-lbWepxys0dEco",
      authDomain: "prenotazioni-app-87467.firebaseapp.com",
      projectId: "prenotazioni-app-87467",
      storageBucket: "prenotazioni-app-87467.firebasestorage.app",
      messagingSenderId: "322391103742",
      appId: "1:322391103742:web:6f74e033b57281bdaaedaf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Login handler
    document.getElementById('login-submit').addEventListener('click', async () => {
      const user = document.getElementById('login-username').value.trim();
      const pass = document.getElementById('login-password').value;
      try {
        const snapshot = await db.collection('admins')
          .where('username', '==', user)
          .limit(1)
          .get();
        if (!snapshot.empty && snapshot.docs[0].data().password === pass) {
          modal.classList.remove('active');
          window.location.href = 'gestione.html';
          return;
        }
        document.getElementById('login-error').textContent = 'Credenziali non valide';
      } catch {
        document.getElementById('login-error').textContent = 'Errore di connessione';
      }
    });

    // Easter calculation (Meeus)
    function calculateEaster(year) {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const L = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * L) / 451);
      const month = Math.floor((h + L - 7 * m + 114) / 31);
      const day = ((h + L - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    // Italian holidays
    function getItalianHolidays(year) {
      const easter = calculateEaster(year);
      const easterMon = new Date(easter);
      easterMon.setDate(easter.getDate() + 1);
      const fixed = [
        new Date(year, 0, 1), new Date(year, 0, 6),
        new Date(year, 3, 25), new Date(year, 4, 1),
        new Date(year, 5, 2), new Date(year, 7, 15),
        new Date(year, 10, 1), new Date(year, 11, 8),
        new Date(year, 11, 25), new Date(year, 11, 26)
      ];
      return [easter, easterMon, ...fixed].map(d =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')} -${String(d.getDate()).padStart(2, '0')}`
      );
    }

    // Render calendar
    function renderCalendar() {
      const today = window.calendarDate;
      const year = today.getFullYear();
      const month = today.getMonth();
      const holidays = getItalianHolidays(year);
      const monthName = today.toLocaleString('it-IT', { month: 'long' });
      document.getElementById('month-year').textContent =
        monthName.charAt(0).toUpperCase() + monthName.slice(1) + ' ' + year;

      const daysRow = document.getElementById('day-names');
      daysRow.innerHTML = '';
      ['Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato','Domenica']
        .forEach(d => { const th = document.createElement('th'); th.textContent = d; daysRow.appendChild(th); });

      const firstDay = new Date(year, month, 1);
      const start = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const totalCells = start + daysInMonth;
      const rows = Math.ceil(totalCells / 7);
      const body = document.getElementById('calendar-body');
      body.innerHTML = '';
      let d = 1;
      for (let i = 0; i < rows; i++) {
        const tr = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const td = document.createElement('td');
          const idx = i * 7 + j;
          if (idx < start || d > daysInMonth) td.textContent = '';
          else {
            const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            td.textContent = d;
            if (j === 6) td.classList.add('sunday');
            if (holidays.includes(ds)) td.classList.add('holiday');
            d++;
          }
          tr.appendChild(td);
        }
        body.appendChild(tr);
      }
    }

    window.calendarDate = new Date();
    document.getElementById('prev-month').addEventListener('click', () => {
      window.calendarDate.setMonth(window.calendarDate.getMonth() - 1);
      renderCalendar();
    });
    document.getElementById('next-month').addEventListener('click', () => {
      window.calendarDate.setMonth(window.calendarDate.getMonth() + 1);
      renderCalendar();
    });
    renderCalendar();
  </script>
