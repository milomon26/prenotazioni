
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Calendario</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

  <div class="header">
    <button class="btn" onclick="logout()">Logout</button>
  </div>

  <div class="calendar-header">
    <button class="btn-nav" onclick="changeMonth(-1)">‚ùÆ</button>
    <h2 id="monthYear"></h2>
    <button class="btn-nav" onclick="changeMonth(1)">‚ùØ</button>
  </div>

  <table id="calendar">
    <thead>
      <tr>
        <th>Luned√¨</th>
        <th>Marted√¨</th>
        <th>Mercoled√¨</th>
        <th>Gioved√¨</th>
        <th>Venerd√¨</th>
        <th>Sabato</th>
        <th>Domenica</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <button class="close-btn" onclick="document.getElementById('edit-modal').classList.remove('active')">‚úñ</button>
      <h3>Dettagli Slot</h3>
      <p><strong>Data:</strong> <span id="edit-date"></span></p>
      <label>Ora: <input id="edit-time" readonly></label>
      <label>Nome: <input id="edit-name" readonly></label>
      <label>Telefono: <input id="edit-phone" readonly></label>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      // inserisci qui la tua configurazione Firebase
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function logout() {
      window.location.href = 'login.html';
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar(currentMonth, currentYear);
    }

    function renderCalendar(month, year) {
      const tbody = document.querySelector("#calendar tbody");
      tbody.innerHTML = "";

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthYear = document.getElementById("monthYear");
      monthYear.textContent = new Date(year, month).toLocaleDateString("it-IT", { month: "long", year: "numeric" });

      let date = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");

        for (let j = 1; j <= 7; j++) {
          const cell = document.createElement("td");
          cell.classList.add("calendar-cell");
          if (i === 0 && j < (firstDay || 7)) {
            row.appendChild(cell);
          } else if (date > daysInMonth) {
            break;
          } else {
            const dayNumber = document.createElement("div");
            dayNumber.className = "day-number";
            dayNumber.textContent = String(date).padStart(2, '0');
            cell.appendChild(dayNumber);

            const dateStr = \`\${year}-\${String(month + 1).padStart(2, '0')}-\${String(date).padStart(2, '0')}\`;
            const slotsContainer = document.createElement("div");
            slotsContainer.className = "slots-container";
            cell.appendChild(slotsContainer);

            db.collection("slots")
              .where("date", "==", dateStr)
              .orderBy("time")
              .get()
              .then(snapshot => {
                const arr = [];
                snapshot.forEach(doc => {
                  const data = doc.data();
                  data.id = doc.id;
                  arr.push(data);
                });

                arr.forEach(s => {
                  const div = document.createElement("div");
                  div.className = "slot-time";
                  if (s.occupato) div.style.background = "#ffcdd2";
                  div.innerHTML = \`
                    <span class="slot-click" style="cursor:pointer">\${s.time}</span>
                    <span>
                      <button class="vis-btn" title="Toggle visibilit√†">\${s.visibile ? 'üëÅÔ∏è' : 'üôà'}</button>
                      <button class="trash-btn" title="Elimina">üóëÔ∏è</button>
                    </span>
                  \`;

                  div.querySelector(".slot-click").onclick = () => showDetailsModal(s);
                  div.querySelector(".vis-btn").onclick = () => toggleVisibility(s.id, s.visibile);
                  div.querySelector(".trash-btn").onclick = () => deleteSlot(s.id);
                  slotsContainer.appendChild(div);
                });
              });

            date++;
            row.appendChild(cell);
          }
        }

        tbody.appendChild(row);
      }
    }

    function toggleVisibility(id, current) {
      db.collection("slots").doc(id).update({ visibile: !current }).then(() => {
        renderCalendar(currentMonth, currentYear);
      });
    }

    function deleteSlot(id) {
      if (confirm("Eliminare questo slot?")) {
        db.collection("slots").doc(id).delete().then(() => {
          renderCalendar(currentMonth, currentYear);
        });
      }
    }

    function showDetailsModal(s) {
      document.getElementById("edit-date").textContent = s.date;
      document.getElementById("edit-time").value = s.time;
      document.getElementById("edit-name").value = s.nome || '';
      document.getElementById("edit-phone").value = s.telefono || '';
      document.getElementById("edit-modal").classList.add("active");
    }

    renderCalendar(currentMonth, currentYear);
  </script>

</body>
</html>
