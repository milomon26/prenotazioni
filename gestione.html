<!-- gestione.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <style>
    /* Ensure modal is on top and clickable */
    .modal { z-index: 1000; }
    .modal-content { z-index: 1001; pointer-events: auto; }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Cute</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Menu -->
  <nav class="dropdown-menu">
    <button class="menu-button" id="menu-button-2">Menu</button>
    <ul class="menu-list">
      <li class="menu-item" id="home-button">Home Cute</li>
    </ul>
  </nav>

  <!-- Slot Modal -->
  <div id="slot-modal" class="modal">
    <div class="modal-content">
      <span id="close-slot-modal" class="close">√ó</span>
      <h2>Nuovo Slot</h2>
      <label>
        Ora Inizio:
        <select id="start-hour"></select> : <select id="start-min"></select>
      </label><br>
      <label>
        Ora Fine:
        <select id="end-hour"></select> : <select id="end-min"></select>
      </label><br>
      <label><input type="checkbox" id="slot-visible"> Visibile</label><br>
      <label><input type="checkbox" id="slot-occupied"> Occupato</label><br>
      <button id="slot-save" class="menu-button">Salva</button>
      <button id="slot-cancel" class="menu-button">Annulla</button>
      <span id="slot-delete" class="delete-icon">üóëÔ∏è</span>
    </div>
  </div>

  <!-- Calendario Gestione -->
  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev2-month">‚Üê</button>
      <h2 id="month2-year"></h2>
      <button id="next2-month">‚Üí</button>
    </div>
    <table class="calendar">
      <thead>
        <tr id="day2-names"></tr>
      </thead>
      <tbody id="calendar2-body"></tbody>
    </table>
  </div>

  <script>
    // Firebase initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBTc-IEX2IlfQXwL2n-r-lbWepxys0dEco",
      authDomain: "prenotazioni-app-87467.firebaseapp.com",
      projectId: "prenotazioni-app-87467",
      storageBucket: "prenotazioni-app-87467.firebasestorage.app",
      messagingSenderId: "322391103742",
      appId: "1:322391103742:web:6f74e033b57281bdaaedaf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Menu click-to-open
    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-menu .menu-list').forEach(ul => ul.style.display = 'none');
    });
    document.getElementById('menu-button-2').addEventListener('click', e => {
      e.stopPropagation();
      const ul = document.querySelector('.dropdown-menu .menu-list');
      ul.style.display = ul.style.display === 'block' ? 'none' : 'block';
    });
    document.getElementById('home-button').addEventListener('click', () => window.location.href = 'index.html');

    // Populate time selects
    const hours = Array.from({ length: 14 }, (_, i) => i + 7);
    const mins = ['00', '15', '30', '45'];
    function populateTime(hourId, minId) {
      const hSel = document.getElementById(hourId);
      const mSel = document.getElementById(minId);
      hours.forEach(h => hSel.add(new Option(h, h)));
      mins.forEach(m => mSel.add(new Option(m, m)));
    }
    populateTime('start-hour', 'start-min');
    populateTime('end-hour', 'end-min');

    // Slot modal logic
    const slotModal = document.getElementById('slot-modal');
    let selectedDate;
    document.getElementById('close-slot-modal').addEventListener('click', () => slotModal.classList.remove('active'));
    document.getElementById('slot-cancel').addEventListener('click', () => slotModal.classList.remove('active'));
    document.getElementById('slot-save').addEventListener('click', async () => {
      // Read values
      const startH = document.getElementById('start-hour').value;
      const startM = document.getElementById('start-min').value;
      const endH = document.getElementById('end-hour').value;
      const endM = document.getElementById('end-min').value;
      const visible = document.getElementById('slot-visible').checked;
      const occupied = document.getElementById('slot-occupied').checked;
      // Save to Firestore
      try {
        await db.collection('slot').add({
          date: selectedDate,
          start: `${startH}:${startM}`,
          end: `${endH}:${endM}`,
          visible,
          occupied
        });
        slotModal.classList.remove('active');
        // Refresh calendar
        await renderCalendar2();
      } catch (e) {
        console.error('Errore salvataggio slot:', e);
        alert('Impossibile salvare lo slot.');
      }
    });
    let selectedDate;
    document.getElementById('close-slot-modal').addEventListener('click', () => slotModal.classList.remove('active'));
    document.getElementById('slot-cancel').addEventListener('click', () => slotModal.classList.remove('active'));
    document.getElementById('slot-save').addEventListener('click', async () => {
      slotModal.classList.remove('active');
      // Aggiorna il calendario e attendi il completamento
      await renderCalendar2();
    });

    // Calendar rendering functions
    function calculateEaster(year) {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const L = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * L) / 451);
      const month = Math.floor((h + L - 7 * m + 114) / 31);
      const day = ((h + L - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }
    function getItalianHolidays(year) {
      const easter = calculateEaster(year);
      const easterMon = new Date(easter);
      easterMon.setDate(easter.getDate() + 1);
      const fixed = [
        new Date(year, 0, 1), new Date(year, 0, 6),
        new Date(year, 3, 25), new Date(year, 4, 1),
        new Date(year, 5, 2), new Date(year, 7, 15),
        new Date(year, 10, 1), new Date(year, 11, 8),
        new Date(year, 11, 25), new Date(year, 11, 26)
      ];
      return [easter, easterMon, ...fixed].map(d =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
      );
    }
    async function renderCalendar2() {
      const year = window.calendar2Date.getFullYear();
      const month = window.calendar2Date.getMonth();
      const holidays = getItalianHolidays(year);
      const slotsSnap = await db.collection('slot')
        .where('date', '>=', `${year}-${String(month + 1).padStart(2, '0')}-01`)
        .where('date', '<=', `${year}-${String(month + 1).padStart(2, '0')}-31`)
        .get();
      const slotsByDay = {};
      slotsSnap.docs.forEach(doc => {
        const s = doc.data();
        const day = Number(s.date.split('-')[2]);
        if (!slotsByDay[day]) slotsByDay[day] = [];
        slotsByDay[day].push(s);
      });
      const mn = window.calendar2Date.toLocaleString('it-IT', { month: 'long' });
      document.getElementById('month2-year').textContent = mn.charAt(0).toUpperCase() + mn.slice(1) + ' ' + year;
      const head = document.getElementById('day2-names'); head.innerHTML = '';
      ['Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato','Domenica']
        .forEach(d => { const th = document.createElement('th'); th.textContent = d; head.appendChild(th); });
      const firstDay = new Date(year, month, 1);
      const start = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const rows = Math.ceil((start + daysInMonth) / 7);
      const body = document.getElementById('calendar2-body'); body.innerHTML = '';
      let date = 1;
      for (let i = 0; i < rows; i++) {
        const tr = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const td = document.createElement('td');
          const idx = i * 7 + j;
          if (idx < start || date > daysInMonth) {
            td.textContent = '';
          } else {
            td.innerHTML = `<div class="day-number">${date}</div>`;
            (slotsByDay[date] || []).forEach(s => {
              const div = document.createElement('div');
              div.classList.add(s.occupied ? 'slot-occupied' : 'slot-free');
              div.textContent = `${s.start}-${s.end}${s.visible ? ' ‚úì' : ''}`;
              td.appendChild(div);
            });
            td.addEventListener('dblclick', () => {
              selectedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
              slotModal.classList.add('active');
            });
            date++;
          }
          tr.appendChild(td);
        }
        body.appendChild(tr);
      }
    }

    window.calendar2Date = new Date();
    document.getElementById('prev2-month').addEventListener('click', () => { window.calendar2Date.setMonth(window.calendar2Date.getMonth() - 1); renderCalendar2(); });
    document.getElementById('next2-month').addEventListener('click', () => { window.calendar2Date.setMonth(window.calendar2Date.getMonth() + 1); renderCalendar2(); });
    renderCalendar2();
  </script>
</body>
</html>
