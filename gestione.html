<!-- gestione.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Cute</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Menu -->
  <nav class="dropdown-menu">
    <button class="menu-button" id="menu-button-2">Menu</button>
    <ul class="menu-list">
      <li class="menu-item" id="home-button">Home Cute</li>
    </ul>
  </nav>

  <!-- Slot Modal -->
  <div id="slot-modal" class="modal">
    <div class="modal-content">
      <span id="close-slot-modal" class="close">√ó</span>
      <h2>Nuovo Slot</h2>
      <label>
        Ora Inizio:
        <select id="start-hour"></select> : <select id="start-min"></select>
      </label><br>
      <label>
        Ora Fine:
        <select id="end-hour"></select> : <select id="end-min"></select>
      </label><br>
      <label><input type="checkbox" id="slot-visible"> Visibile</label><br>
      <label><input type="checkbox" id="slot-occupied"> Occupato</label><br>
      <button id="slot-save" class="menu-button">Salva</button>
      <button id="slot-cancel" class="menu-button">Annulla</button>
      <span id="slot-delete" class="delete-icon">üóëÔ∏è</span>
    </div>
  </div>

  <!-- Calendario Gestione -->
  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev2-month">‚Üê</button>
      <h2 id="month2-year"></h2>
      <button id="next2-month">‚Üí</button>
    </div>
    <table class="calendar">
      <thead><tr id="day2-names"></tr></thead>
      <tbody id="calendar2-body"></tbody>
    </table>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = { /* config */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Menu
    document.addEventListener('click',()=>document.querySelectorAll('.dropdown-menu .menu-list').forEach(ul=>ul.style.display='none'));
    document.getElementById('menu-button-2').addEventListener('click',e=>{e.stopPropagation();const ul=document.querySelector('.dropdown-menu .menu-list');ul.style.display=ul.style.display==='block'?'none':'block';});
    document.getElementById('home-button').addEventListener('click',()=>window.location.href='index.html');

    // Populate time selects
    const hours = Array.from({length:14},(_,i)=>i+7);
    const mins = ['00','15','30','45'];
    function populateTime(idHour,idMin){
      const hSel=document.getElementById(idHour), mSel=document.getElementById(idMin);
      hours.forEach(h=>hSel.add(new Option(h,h)));
      mins.forEach(m=>mSel.add(new Option(m,m)));
    }
    populateTime('start-hour','start-min');
    populateTime('end-hour','end-min');

    // Slot modal logic
    const slotModal=document.getElementById('slot-modal');
    let selectedDate;
    document.getElementById('close-slot-modal').addEventListener('click',()=>slotModal.classList.remove('active'));
    document.getElementById('slot-cancel').addEventListener('click',()=>slotModal.classList.remove('active'));
    document.getElementById('slot-save').addEventListener('click',async()=>{
      const startH=document.getElementById('start-hour').value;
      const startM=document.getElementById('start-min').value;
      const endH=document.getElementById('end-hour').value;
      const endM=document.getElementById('end-min').value;
      const visible=document.getElementById('slot-visible').checked;
      const occupied=document.getElementById('slot-occupied').checked;
      await db.collection('slot').add({
        date:selectedDate,
        start:`${startH}:${startM}`,
        end:`${endH}:${endM}`,
        visible, occupied
      });
      slotModal.classList.remove('active');
      renderCalendar2();
    });
    document.getElementById('slot-delete').addEventListener('click',async()=>{
      // implement deletion logic if needed
    });

    // Calendar functions
    function calculateEaster(y){/*...*/}
    function getItalianHolidays(y){/*...*/}
    async function renderCalendar2(){
      const year=window.calendar2Date.getFullYear();
      const month=window.calendar2Date.getMonth();
      const holidays=getItalianHolidays(year);
      // fetch slots
      const slotsSnap=await db.collection('slot').where('date','>=',`${year}-${month+1}-01`) .where('date','<=',`${year}-${month+1}-31`).get();
      const slotsByDay={};
      slotsSnap.docs.forEach(doc=>{
        const s=doc.data();
        const day=Number(s.date.split('-')[2]);
        if(!slotsByDay[day]) slotsByDay[day]=[];
        slotsByDay[day].push(s);
      });
      // render header
      let mn=window.calendar2Date.toLocaleString('it-IT',{month:'long'});
      mn=mn.charAt(0).toUpperCase()+mn.slice(1);
      document.getElementById('month2-year').textContent=mn+' '+year;
      const head=document.getElementById('day2-names');head.innerHTML='';
      ['Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato','Domenica']
        .forEach(d=>{const th=document.createElement('th');th.textContent=d;head.appendChild(th);} )
      const first=new Date(year,month,1);
      const start=(first.getDay()+6)%7;
      const dim=new Date(year,month+1,0).getDate();
      const rows=Math.ceil((start+dim)/7);
      const body=document.getElementById('calendar2-body');body.innerHTML='';
      let date=1;
      for(let i=0;i<rows;i++){
        const tr=document.createElement('tr');
        for(let j=0;j<7;j++){
          const td=document.createElement('td');
          if(i*7+j<start||date>dim){td.textContent='';}
          else{
            td.classList.add(slotsByDay[date]?.some(s=>s.occupied)?'occupied':'free');
            td.innerHTML=`<div class="day-number">${date}</div>`;
            // append slots
            (slotsByDay[date]||[]).forEach(s=>{
              const div=document.createElement('div');
              div.textContent=`${s.start}-${s.end}${s.visible?' ‚úì':''}`;
              td.appendChild(div);
            });
            td.addEventListener('dblclick',()=>{
              selectedDate=`${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
              slotModal.classList.add('active');
            });
            date++;
          }
          tr.appendChild(td);
        }
        body.appendChild(tr);
      }
    }

    window.calendar2Date=new Date();
    document.getElementById('prev2-month').addEventListener('click',()=>{window.calendar2Date.setMonth(window.calendar2Date.getMonth()-1);renderCalendar2();});
    document.getElementById('next2-month').addEventListener('click',()=>{window.calendar2Date.setMonth(window.calendar2Date.getMonth()+1);renderCalendar2();});
    renderCalendar2();
  </script>
