<!-- gestione.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Cute</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: 'Comic Neue', cursive, sans-serif; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); align-items:center; justify-content:center; pointer-events:none; z-index:2000; }
    .modal.active { display:flex; pointer-events:auto; }
    .modal-content { background:#fff; padding:20px; border-radius:12px; min-width:320px; pointer-events:auto; }
    .close { position:absolute; top:10px; right:10px; cursor:pointer; }
    .form-row { margin-top:10px; }
    .form-actions { margin-top:20px; display:flex; justify-content:space-between; }
    .slot-free { background:#d4edda; padding:4px; border-radius:4px; margin-top:4px; display:flex; justify-content:space-between; }
    .slot-occupied { background:#f8d7da; padding:4px; border-radius:4px; margin-top:4px; display:flex; justify-content:space-between; }
    .slot-controls { display:flex; align-items:center; }
    .slot-controls input { margin-right:4px; }
    .trash-icon { cursor:pointer; margin-left:4px; }
    .more-link { color:#007bff; cursor:pointer; margin-top:4px; display:inline-block; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <nav class="dropdown-menu">
    <button class="menu-button" id="menu-button-2">Menu</button>
    <ul class="menu-list"><li class="menu-item" id="home-button">Home Cute</li></ul>
  </nav>

  <div id="slot-modal" class="modal">
    <div class="modal-content">
      <span id="close-slot-modal" class="close">√ó</span>
      <h2>Nuovo Slot</h2>
      <div class="form-row"><label>Ora Inizio: <select id="start-hour"></select>:<select id="start-min"></select></label></div>
      <div class="form-row"><label>Ora Fine: <select id="end-hour"></select>:<select id="end-min"></select></label></div>
      <div class="form-row"><label><input type="checkbox" id="slot-visible"> Visibile</label></div>
      <div class="form-row"><label><input type="checkbox" id="slot-occupied"> Occupato</label></div>
      <div class="form-actions"><button id="slot-save" class="menu-button">Salva</button><button id="slot-cancel" class="menu-button">Annulla</button></div>
    </div>
  </div>

  <div id="extras-modal" class="modal">
    <div class="modal-content">
      <span id="close-extras-modal" class="close">√ó</span>
      <h2>Altri Slot</h2>
      <div id="extras-list"></div>
    </div>
  </div>

  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prev2-month">‚Üê</button><h2 id="month2-year"></h2><button id="next2-month">‚Üí</button>
    </div>
    <table class="calendar"><thead><tr id="day2-names"></tr></thead><tbody id="calendar2-body"></tbody></table>
  </div>

  <script>
    const firebaseConfig = { apiKey:"...", authDomain:"...", projectId:"...", storageBucket:"...", messagingSenderId:"...", appId:"..." };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener('click',()=>document.querySelectorAll('.menu-list').forEach(u=>u.style.display='none'));
    document.getElementById('menu-button-2').addEventListener('click',e=>{e.stopPropagation();const u=document.querySelector('.dropdown-menu .menu-list');u.style.display=u.style.display==='block'?'none':'block';});
    document.getElementById('home-button').addEventListener('click',()=>location.href='index.html');

    const hours=Array.from({length:14},(_,i)=>i+7), mins=['00','15','30','45'];
    function populate(hId,mId){const h=document.getElementById(hId),m=document.getElementById(mId);hours.forEach(x=>h.add(new Option(x,x)));mins.forEach(x=>m.add(new Option(x,x)));}
    populate('start-hour','start-min');populate('end-hour','end-min');

    const slotModal=document.getElementById('slot-modal');let selectedDate;
    document.getElementById('close-slot-modal').addEventListener('click',()=>slotModal.classList.remove('active'));
    document.getElementById('slot-cancel').addEventListener('click',()=>slotModal.classList.remove('active'));

    const extrasModal=document.getElementById('extras-modal');
    document.getElementById('close-extras-modal').addEventListener('click',()=>extrasModal.classList.remove('active'));

    document.getElementById('slot-save').addEventListener('click',async()=>{
      const start=`${document.getElementById('start-hour').value}:${document.getElementById('start-min').value}`;
      const end=`${document.getElementById('end-hour').value}:${document.getElementById('end-min').value}`;
      const visible=document.getElementById('slot-visible').checked;
      const occupied=document.getElementById('slot-occupied').checked;
      const docId=`${selectedDate}_${start.replace(':','')}_${end.replace(':','')}`;
      const docRef=db.collection('slots').doc(docId);
      const existing=await docRef.get();
      if(!existing.exists) await docRef.set({date:selectedDate,start,end,visible,occupied}); else alert('Slot gi√† esistente');
      slotModal.classList.remove('active');await renderCalendar2();
    });

    function calculateEaster(y){/* Meeus */}
    function getItalianHolidays(y) {
      const easter = calculateEaster(y);
      const easterMon = new Date(easter);
      easterMon.setDate(easter.getDate() + 1);
      const fixed = [
        new Date(y, 0, 1), new Date(y, 0, 6),
        new Date(y, 3, 25), new Date(y, 4, 1),
        new Date(y, 5, 2), new Date(y, 7, 15),
        new Date(y, 10, 1), new Date(y, 11, 8),
        new Date(y, 11, 25), new Date(y, 11, 26)
      ];
      const all = [easter, easterMon, ...fixed];
      return all.map(d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
    }
-${mm}-${dd}`;
      });
    }catch{return [];} }

    async function renderCalendar2(){
      const today=window.calendar2Date,y=today.getFullYear(),M=today.getMonth();
      let holidays=[]; try{holidays=getItalianHolidays(y);}catch{};
      const dim=new Date(y,M+1,0).getDate();
      const sD=`${y}-${String(M+1).padStart(2,'0')}-01`,eD=`${y}-${String(M+1).padStart(2,'0')}-${String(dim).padStart(2,'0')}`;
      const snap=await db.collection('slots').where('date','>=',sD).where('date','<=',eD).get();
      const byDay={};snap.docs.forEach(d=>{const s=d.data(),day=Number(s.date.split('-')[2]);(byDay[day]||(byDay[day]=[])).push(s);});
      document.getElementById('month2-year').textContent=today.toLocaleString('it-IT',{month:'long'}).replace(/^./,c=>c.toUpperCase())+` ${y}`;
      const head=document.getElementById('day2-names');head.innerHTML='';['Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato','Domenica'].forEach(n=>{const th=document.createElement('th');th.textContent=n;head.appendChild(th);});
      const first=new Date(y,M,1),start=(first.getDay()+6)%7,rows=Math.ceil((start+dim)/7),body=document.getElementById('calendar2-body');body.innerHTML='';let d=1;
      for(let i=0;i<rows;i++){const tr=document.createElement('tr');for(let j=0;j<7;j++){const td=document.createElement('td'),idx=i*7+j;if(idx<start||d>dim){td.textContent='';}else{td.innerHTML=`<div class="day-number">${d}</div>`;if(j===6)td.classList.add('sunday');const ds=`${y}-${String(M+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(holidays.includes(ds))td.classList.add('holiday');const slots=byDay[d]||[];slots.slice(0,4).forEach(s=>{const div=document.createElement('div');div.classList.add(s.occupied?'slot-occupied':'slot-free');div.innerHTML=`${s.start}-${s.end}<span class="slot-controls"><input type="checkbox"${s.visible?' checked':''}><input type="checkbox"${s.occupied?' checked':''}><span class="trash-icon" data-date="${ds}" data-start="${s.start}" data-end="${s.end}">üóëÔ∏è</span></span>`;td.appendChild(div);});if(slots.length>4){const more=document.createElement('div');more.classList.add('more-link');more.textContent=`Vedi gli altri ${slots.length-4} slot`;more.addEventListener('click',()=>showExtras(ds,slots));td.appendChild(more);}td.addEventListener('dblclick',e=>{e.stopPropagation();selectedDate=ds;slotModal.classList.add('active');});d++;}tr.appendChild(td);}body.appendChild(tr);}    }
    function showExtras(date,slots){const list=document.getElementById('extras-list');list.innerHTML='';slots.forEach(s=>{const row=document.createElement('div');row.classList.add(s.occupied?'slot-occupied':'slot-free');row.innerHTML=`${s.start}-${s.end}<span class="slot-controls"><input type="checkbox"${s.visible?' checked':''}><input type="checkbox"${s.occupied?' checked':''}><span class="trash-icon">üóëÔ∏è</span></span>`;list.appendChild(row);});extrasModal.classList.add('active');}
    window.calendar2Date=new Date();document.getElementById('prev2-month').addEventListener('click',()=>{calendar2Date.setMonth(calendar2Date.getMonth()-1);renderCalendar2();});document.getElementById('next2-month').addEventListener('click',()=>{calendar2Date.setMonth(calendar2Date.getMonth()+1);renderCalendar2();});renderCalendar2();
  </script>
</body>
</html>
